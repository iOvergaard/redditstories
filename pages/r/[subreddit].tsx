import marked from 'marked';
import { GetStaticPathsResult, GetStaticPropsContext, GetStaticPropsResult, NextPage } from 'next';
import Head from 'next/head';

import Layout from '../../components/layout';
import Post from '../../components/post';
import { tryGetSubreddit } from '../../lib/reddit';
import styles from '../../styles/Subreddit.module.css';

type Props = {
  subreddit: string;
  posts: any[];
};

const Subreddit: NextPage<Props> = (props: Props) => {
  return (
    <Layout title={props.subreddit}>
      <Head>
        <title>Subreddit {props.subreddit}</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      {props.posts.length
        ? props.posts.map((post) => (
            <div key={post.id} className={styles.post}>
              <Post post={post} />
            </div>
          ))
        : "No posts found"}
    </Layout>
  );
};

export function getStaticPaths(): GetStaticPathsResult {
  return {
    paths: ["/r/gonewildstories", "/r/talesfromtechsupport"],
    fallback: "blocking",
  };
}

export async function getStaticProps(
  context: GetStaticPropsContext<Props>
): Promise<GetStaticPropsResult<Props>> {
  const subreddit = context.params?.subreddit;

  if (!subreddit) {
    return {
      notFound: true,
    };
  }

  let posts = await tryGetSubreddit(subreddit);

  if (!posts) {
    return {
      notFound: true,
    };
  }

  posts.forEach((post: any) => {
    post.selftext = marked(post.selftext);
  });

  return {
    props: {
      subreddit,
      posts,
    },
    revalidate: 300,
  };
}

export default Subreddit;
