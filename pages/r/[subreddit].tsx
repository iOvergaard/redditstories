import {
  GetStaticPathsResult,
  GetStaticPropsContext,
  GetStaticPropsResult,
  NextPage,
} from "next";
import Head from "next/head";
import { tryGetSubreddit } from "../../lib/reddit";
import styles from "../../styles/Home.module.css";

type Props = {
  subreddit: string;
  posts: any[];
};

const Subreddit: NextPage<Props> = (props: Props) => {
  return (
    <div className={styles.container}>
      <main className={styles.main}>
        <Head>
          <title>Subreddit {props.subreddit}</title>
          <meta name="description" content="Generated by create next app" />
          <link rel="icon" href="/favicon.ico" />
        </Head>

        <h1 className={styles.title}>{props.subreddit}</h1>
        {props.posts.length
          ? props.posts.map((post) => (
              <article key={post.id}>
                <h3>{post.title}</h3>
                <div style={{ whiteSpace: "pre-line" }}>{post.selftext}</div>
              </article>
            ))
          : "No posts found"}
      </main>
    </div>
  );
};

export function getStaticPaths(): GetStaticPathsResult {
  return {
    paths: ["/r/gonewildstories", "/r/talesfromtechsupport"],
    fallback: "blocking",
  };
}

export async function getStaticProps(
  context: GetStaticPropsContext<Props>
): Promise<GetStaticPropsResult<Props>> {
  const subreddit = context.params?.subreddit;

  if (!subreddit) {
    return {
      notFound: true,
    };
  }

  const posts = await tryGetSubreddit(subreddit);

  if (!posts) {
    return {
      notFound: true,
    };
  }

  return {
    props: {
      subreddit,
      posts,
    },
    revalidate: 300,
  };
}

export default Subreddit;
